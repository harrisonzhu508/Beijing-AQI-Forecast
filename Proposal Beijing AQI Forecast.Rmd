---
title: 'Proposal: Beijing AQI Forecast'
author: "Harrison Zhu and Xinnuo Lin"
date: "18 March 2018"
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Loading libraries,echo = FALSE}
library(readr)
library(car)
library(tseries)

#Read dataframe
Beijing <- suppressMessages(read_csv("~/Desktop/Semestre 2/7. Time Series/Project/beijing23 - Sheet1.csv"))

Beijing_TS <- ts(Beijing$AQI)

#logdiff transformation
log_Beijing_TS <- log(Beijing_TS)
diff_log_beijing <- diff(log_Beijing_TS)


```
#Description of the Dataset#

The data we found are hourly recorded air quality indexes (AQI) at Olympic Centre in Beijing, China. These data defined the degree of the whole air quality in certain area based on the level of sulfur dioxide (SO2), nitrogen dioxide (NO2), suspended particulates smaller than 10 $\mu$m in aerodynamic diameter (PM10), suspended particulates smaller than 2.5 $\mu$m in aerodynamic diameter (PM2.5)ï¼Œcarbon monoxide (CO), and ozone (O3) . Since it is an index demonstrating all the six factors, it has no official unit. The detailed calculation of AQI in Mainland China can be found at this website.
**ADD REFERENCE**
\url(http://bz.mep.gov.cn/bzwb/dqhjbh/jcgfffbz/201203/W020120410332725219541.pdf} 

##Data Cleaning##

When we check the specific data, there exist some non-value hours so the data we use is the value of AQI at 12:00 pm measured from the second of January in 2015 to the 30th of January in 2018. In fact, there are still non-value data at 12:00 pm. We then completed the dataset by taking the average between the closest 2 times earlier and later than 12:00 each day. For example, we would take the average of the AQI values at 11:00 and 13:00. This may have consequences on the accuracy of our models, but as there were less than 100 missing values compared to the size of the dataset, which contains 1000+ data points, this incurs only a minor penalty. The original data can be downloaded from a link from the page. 

#Exploratory Data Analysis

Figure 1 shows the rare data set. The time series is clearly no stationary. The variance changes frequently as time increases. And there seems to be a periodicity. To stabilize the variance, we first apply a logarithmic transformation to the data and use the first difference to remove the trend. The processed data is shown in Figure 2. Now it looks like stationary so that we may apply ARMA models to fit it.

Figure 3 shows the correlogram and the partial correlogram of the processed data. We can see in the correlogram that values are almost zero after lag 3 which assumes that an MA(3) model may fit. The partial correlogram tails off which shows an ARMA model may fit.

```{r}
#Figure 1

plot(Beijing_TS,main = "Original Dataset: Plot", xlab = "Time", ylab = "AQI")

#Figure 2
plot(diff_log_beijing <- diff(log_Beijing_TS), main = "Processed Data")

#Figure 3
par(mfrow = c(1,2))
#acf
acf(diff_log_beijing, main = "Logdiff Dataset: ACF")
#pacf
pacf(diff_log_beijing, main = "Logdiff Dataset: PACF")


```

##Original Dataset##
We begin first by examining the original dataset with a plot of the dataset and its ACF and PACF plots. To test for stationary, we use the KPSS test. 


```{r, echo=FALSE}
par(mfrow = c(1, 3),pty = "s")

#time series conversion
Beijing_TS <- ts(Beijing$AQI)
plot(Beijing_TS,main = "Original Dataset: Plot", xlab = "Time", ylab = "AQI")
acf(Beijing_TS, main = "Original Dataset: ACF")
pacf(Beijing_TS, main = "Original Dataset: PACF")

#kpss test
kpss.test(Beijing_TS)
```


We see that the $p$-value is lower than 10%, indicating that we have sufficient evidence reject the null hypothesis that there is stationary at 10% level. 

##Transformed Dataset##

We now transform our dataset via the $\log$ and difference transforms:
$$
Z_{t} := D\log(Y_{t}),
$$
where $D$ is the difference operator $D = I - B$ such that $D Y_{t} = Y_{t} - Y_{t-1}$. 

```{r, echo=FALSE}
#plots
par(mfrow = c(1, 3),lheight = 1,pty = "s")

#diff
diff_log_beijing <- diff(log_Beijing_TS)
plot(diff_log_beijing,main = "Logdiff Dataset: Plot")

#acf
acf(diff_log_beijing, main = "Logdiff Dataset: ACF")

#pacf
pacf(diff_log_beijing, main = "Logdiff Dataset: PACF")
```

```{r}

#####Box-Cox Transformations

Beijing_root <- Beijing_TS^(0.25)

#polynomial of order 10 try

par(mfrow = c(1, 3),lheight = 1,pty = "s")


plot(Beijing_root,main = "1/4 Dataset: Plot")

#acf
acf(Beijing_root, main = "1/4 Dataset: ACF")

#pacf
pacf(Beijing_root, main = "1/4 Dataset: PACF")

```


Via another KPSS test, we see that the $p$-value is great than 10%, indicating that we have insufficient evidence to reject the null hypothesis that there is stationary at 10% level. 
```{r, echo= FALSE}
#kpss test for stationarity
kpss.test(diff_log_beijing)
```

From the PACF graph of the detrended data, we can see that the AR model cannot be fitted because there is no obvious "shuts off" which shows suddenly decline to zero.  As for the ACF graph, since after lag 2 the values are almost between the confidence interval, an MA(2) model may be fitted.


```{r}
#######Trying out STL Decomposition

Beijing_TS1 <- ts(Beijing$AQI^(0.25),frequency = 90)
plot(stl(Beijing_TS1,s.window = "per",t.window = 101))

```

